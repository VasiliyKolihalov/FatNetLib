# Протокол передачи данных 
Версия: 1  
Статус: в разработке  

## Маршрутизация
С целью определить, какой удаленный метод хочет вызвать вызывающий пир на вызываемом пире, определена концепция роутов. 
Она схожа с http. 

Вместо http глаголов у каждого метода определяется `action` метода. 
Он отражает характер действия вызываемого метода. 
Экшн может совпадать с дефолтными http глаголами (`get`, `post`, `put`, ...), может быть кастомным глаголом (`calculate`, `stop`, ...), может быть глаголом с обстоятельствами (`give-item`, `get-with-pagination`). 

Вместо url определяется `route`. 
Он отражает субъект либо объект действия - это зависит от контекста. 
В стиле директорий файловой системы с разделителями `/`. 
В route допустимы path variables. 
В route нельзя указывать query params, как в http. 

Комбинация action и route позволяет однозначно определить вызываемый метод.  
Перегрузка методов не поддерживается.

## Пакет данных
Каждый пакет данных между пирами в нормальном режиме - это сериализованный data transfer object. 
Формат сериализации не регламентируется. 
Поля не регламентируются. 
Рекомендуемые поля:
- `routing` - для маршрутизации сообщения в нужный метод
    - `action`
    - `route`
- `body` - содержит данные для бизнес логики. 
- `error` - если на вызываемом пире произошла ошибка при обработке запроса, и он обязан вернуть ответ, детали ошибки передаются здесь.
- `auth` - для данных аутентификации и авторизации
- `trace` - для трассировки сообщения. 
    - `exchangeId` - нужен для поиска пары связанных сообщений в режиме запрос-ответ
    - `traceId` - если пир не монолитный, поможет отслеживать между флоу сообщения сервисами
    - `spanId` - если пир не монолитный, поможет отслеживать между флоу сообщения внутри одного сервиса

### Пример пакета данных, сериализованного в json формате
```json
{
    "routing": {
        "action": "give-item",
        "route": "/players/cf0d1fbf-db1c-4cb8-bf67-a06d5668de62"
    },
    "body": {
        "itemId": "553a2844-52c0-4b09-baec-e9c27d74dc39"
    },
    "error": {
        "code": "unauthorized",
        "message": "User is banned"
    },
    "auth": {
        "username": "Vasya",
        "password": "pa$$w0rd"
    },
    "trace": {
        "exchangeId": "70f9ba63-a98d-4958-a6bd-3a90c5aac5a7",
        "traceId": "0677e02b-4d1e-418d-9043-14227f5b674c",
        "spanId": "a6aefb48-e108-4aa1-92b0-d322e84a1283"
    },
    ...
}
```

## Инициализация соединения
1. Клиент подключается к серверу.    
2. Сервер регистрирует клиента и переключается в режим инициализации в контексте нового клиента.  
Отправляет сообщение в формате строки utf-8, содержащее версию протокола
3. Клиент сверяет версию протокола со своей.  
При несовпадении Иначе разрывает соединение.  
При совпадении переходит в режим инициализации.  
4. Клиент выполняет необходимые для инициализации запросы.  
Например, инициализацию шифрования, аутентификацию.  
Все эндпоинты инициализации лежат в роуте `/connection`
6. Когда все инициализирующие запросы выполнены, клиент вызывает `start /connection`.  
Cервер отвечает переходит в нормальный режим работы и вызывает `start /connection` у клиента.  
Клиент переходит в нормальный режим работы.  