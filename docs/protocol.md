# Протокол передачи данных 
Версия: 1  
Статус: в разработке  

## Маршрутизация
С целью определить, какой удаленный эндпоинт хочет вызвать вызывающий пир на вызываемом пире, определена концепция роутов. 
Она схожа с http. 

Вместо url определяется `route`. 
В стиле директорий файловой системы.
Роут сегменты разделены символом `/`. 
Сегменты от первого до предпоследнего включительно отражают субъект либо объект действия - это зависит от контекста.
Энкодинг символа `/` не предусмотрен.
То есть нельзя сделать так, чтобы `/` воспринимался, как значимый символ, а не как разделитель роут сегментов.
В роуте допустимы path variables. 
Такая переменная указывается в фигурных скобках `{var}`. 
Значение переменной указывается в `body`. 
Имя переменной в роуте должно полностью совпадать с именем поля в `body`. 
В роуте нельзя указывать query params, как в http. 

Вместо http глаголов у каждого эндпоинта определяется `action`. 
Он отражает характер действия вызываемого эндпоинта. 
Экшн может совпадать с дефолтными http глаголами (`get`, `post`, `put`, ...), может быть кастомным глаголом (`calculate`, `stop`, ...), может быть глаголом с обстоятельствами (`give-item`, `get-with-pagination`). 
Экшн помещается в самый конец роута, то есть является самым последним роут сегментом.

Route позволяет однозначно определить вызываемый эндпоинт. 
Перегрузка эндпоинт не поддерживается. 

## Пакет
Каждый пакет между пирами в нормальном режиме - это сериализованный data transfer object. 
Формат сериализации не регламентируется. 
Поля не регламентируются. 
Рекомендуемые поля:
- `route` - для маршрутизации пакетов в нужный эндпоинт
- `body` - содержит данные для бизнес логики
- `error` - если на вызываемом пире произошла ошибка при обработке запроса, и он обязан вернуть ответ, детали ошибки передаются здесь.
- `auth` - для данных аутентификации и авторизации
- `trace` - для трассировки пакетов. 
    - `exchangeId` - нужен для поиска пары связанных пакетов в режиме запрос-ответ
    - `traceId` - если пир не монолитный, поможет отслеживать флоу пакета между сервисами
    - `spanId` - если пир не монолитный, поможет отслеживать флоу пакета внутри одного сервиса

### Пример пакета, сериализованного в json формате
```json
{
    "route": "/players/{playerId}/give-item",
    "body": {
        "playerId": "cf0d1fbf-db1c-4cb8-bf67-a06d5668de62",
        "itemId": "553a2844-52c0-4b09-baec-e9c27d74dc39"
    },
    "error": {
        "code": "unauthorized",
        "message": "User is banned"
    },
    "auth": {
        "username": "Vasya",
        "password": "pa$$w0rd"
    },
    "trace": {
        "exchangeId": "70f9ba63-a98d-4958-a6bd-3a90c5aac5a7",
        "traceId": "0677e02b-4d1e-418d-9043-14227f5b674c",
        "spanId": "a6aefb48-e108-4aa1-92b0-d322e84a1283"
    },
    ...
}
```

## Инициализация соединения
1. Клиент подключается к серверу.    
2. Сервер регистрирует клиента и переключается в режим инициализации в контексте нового клиента.  
Отправляет пакет в формате строки utf-8, содержащее версию протокола
3. Клиент сверяет версию протокола со своей.  
При несовпадении разрывает соединение.  
При совпадении переходит в режим инициализации.  
4. Клиент выполняет необходимые для инициализации запросы.  
Например, инициализацию шифрования, аутентификацию, обмен словарями сжатия.  
Все эндпоинты инициализации лежат в роуте `/connection`
6. Когда все инициализирующие запросы выполнены, клиент вызывает `/сonnection/start`.  
Cервер переходит в нормальный режим работы и вызывает `/сonnection/start` у клиента.  
Клиент переходит в нормальный режим работы.  
